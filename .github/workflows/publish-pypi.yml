name: Publish to PyPI

on:
    push:
        tags:
            - "v*" # 例如 v1.2.3、v0.3.0-rc.1

permissions:
    contents: write
    id-token: write

jobs:
    build-and-publish:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install build tools
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install --upgrade build twine

            - name: Build sdist & wheel
              run: python -m build

            - name: Twine check
              run: python -m twine check dist/*

            - name: Verify version matches tag
              run: |
                  TAG="${GITHUB_REF_NAME#v}"
                  PYPROJ_VER=$(python - <<'PY'
                  import tomllib
                  with open("pyproject.toml","rb") as f:
                      data=tomllib.load(f)
                  print(data.get("project",{}).get("version",""))
                  PY
                  )
                  echo "Tag: $TAG"
                  echo "pyproject version: $PYPROJ_VER"
                  [ "$TAG" = "$PYPROJ_VER" ] || { echo "Version mismatch!"; exit 1; }

            - name: Determine release channel
              id: channel
              run: |
                  REF="${GITHUB_REF_NAME}"
                  echo "ref_name=$REF"
                  if [[ "$REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "final=true" >> "$GITHUB_OUTPUT"
                    echo "pre=false" >> "$GITHUB_OUTPUT"
                  elif [[ "$REF" =~ (a|b|rc) ]]; then
                    echo "final=false" >> "$GITHUB_OUTPUT"
                    echo "pre=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "final=false" >> "$GITHUB_OUTPUT"
                    echo "pre=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Publish final to PyPI (OIDC)
              if: steps.channel.outputs.final == 'true'
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist
                  skip-existing: true

            - name: Create GitHub Release
              id: gh_release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true # 自动用 commit 生成说明
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
